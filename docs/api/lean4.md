# provably.lean4

Lean4 backend — generate and check Lean4 proofs from `@verified` contracts.

```python
from provably import verify_with_lean4, export_lean4, HAS_LEAN4, LEAN4_VERSION
```

---

## `HAS_LEAN4`

`bool` — `True` if the `lean` command is available on `$PATH`.

```python
from provably import HAS_LEAN4
if HAS_LEAN4:
    print("Lean4 available")
```

---

## `LEAN4_VERSION`

`str` — version string from `lean --version`, or `""` if Lean4 is not installed.

---

## `verify_with_lean4()`

Verify a function using Lean4 instead of (or in addition to) Z3. Returns a
`ProofCertificate` with `z3_version` set to `"lean4:<version>"`.

```python
from provably import verify_with_lean4

def clamp(val: float, lo: float, hi: float) -> float:
    if val < lo: return lo
    elif val > hi: return hi
    else: return val

cert = verify_with_lean4(
    clamp,
    pre=lambda val, lo, hi: lo <= hi,
    post=lambda val, lo, hi, result: (result >= lo) & (result <= hi),
)
cert.status          # Status.VERIFIED (if Lean4 closes the proof)
cert.z3_version      # "lean4:leanprover/lean4:v4.x.0"
cert.solver_time_ms  # wall-clock ms in lean
```

| Parameter | Type | Default | Description |
|---|---|---|---|
| `func` | `Callable` | required | The function to verify |
| `pre` | `Callable \| None` | `None` | Precondition lambda |
| `post` | `Callable \| None` | `None` | Postcondition lambda |
| `timeout_s` | `float` | `60.0` | Lean4 type-check timeout in seconds |

When Lean4 is not installed, returns a `SKIPPED` certificate with an installation hint.

---

## `export_lean4()`

Export a `@verified` function as a Lean4 theorem file. Returns the Lean4 source
code as a string. Optionally writes to a file.

```python
from provably import export_lean4

lean_code = export_lean4(
    clamp,
    pre=lambda val, lo, hi: lo <= hi,
    post=lambda val, lo, hi, result: (result >= lo) & (result <= hi),
    output_path="clamp.lean",
)
print(lean_code)
# -- Auto-generated by provably.lean4
# import Mathlib.Tactic
# noncomputable def clamp_impl ...
# theorem clamp_verified ...
```

| Parameter | Type | Default | Description |
|---|---|---|---|
| `func` | `Callable` | required | The function to export |
| `pre` | `Callable \| None` | `None` | Precondition lambda |
| `post` | `Callable \| None` | `None` | Postcondition lambda |
| `output_path` | `str \| Path \| None` | `None` | Write Lean4 source to this path |

Does not require Lean4 to be installed (generates code only).

---

## Pipeline

The Lean4 backend follows the same flow as the Z3 backend:

1. Parse function AST + contracts
2. Generate Lean4 `noncomputable def` from the function body
3. Generate `theorem ... := by unfold; split_ifs <;> nlinarith`
4. Write to a temp `.lean` file
5. Run `lean` to type-check
6. Return `ProofCertificate` with outcome

---

## Limitations

- Same arithmetic subset as Z3 translator (no recursion, no data structures)
- Transcendental functions (`exp`, `cos`, `log`) are axiomatized
- For-loop unrolling produces verbose Lean4 proofs
- Slower than Z3 (compiles to native code)
- Requires Lean4 + Mathlib for `nlinarith` tactic

---

## Installation

```bash
# Install elan (Lean4 version manager)
brew install elan-init   # macOS
# or: curl -sSf https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh

# Set stable toolchain
elan default stable
```

---

::: provably.lean4
